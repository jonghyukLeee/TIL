# 데이터 모델링

- 데이터를 정확하고 효율적으로 데이터베이스에 저장하기 위해 데이터 구조를 설계하는 과정

# MongoDB의 데이터 모델링

- RDB 데이터 모델링이 테이블 설계 후 컬럼을 설계하는 순서로 진행된다면, mongoDB 데이터 모델링은 도큐먼트 설계 후 컬렉션을 설계하는 순서로 진행된다.
- 도큐먼트 구조 설계에 따라 데이터 정합성과 성능에 큰 영향을 주게 되므로, 이에 대한 정확한 이해가 필요하다

# 도큐먼트 구조

- RDB의 row와 같은 개념이며, mongoDB에서는 데이터를 저장하는 최소 단위

### 임베디드 방식

- 설명
    - 관계를 갖는 데이터 집합을 단일 도큐먼트에 포함하여 저장하는 방식
    - 데이터 관리가 직관적이고 쿼리가 단순함
- 문제점
    - 데이터 중복은 도큐먼트 구조를 단순화하고 조회 성능을 향상하나 데이터 불일치가 발생할 수 있음
    - 도큐먼트에 포함하는 데이터가 증가할수록 도큐먼트의 크기도 증가하여 디스크 I/O 성능 저하 발생 및 도큐먼트 최대 크기 초과 시 저장이 불가능할 수 있음
    - 데이터 관계가 복잡하거나 계층 구조를 갖는 업무는 관리가 어려움
- 권장
    - 조회 성능이 중요하고 데이터 중복에 따른 데이터 불일치 문제가 발생하지 않는 업무
    - 업데이트가 과도하게 발생하지 않는 업무

### 레퍼런스 방식 (기본)

도큐먼트에 관계를 갖는 다른 도큐먼트의 식별자를 참조키로 저장하여, 애플리케이션에서 조인하는 방식.

- 설명
    - 레퍼런스 방식은 데이터가 중복되지 않도록 업무 성격별로 컬렉션을 분리 후 참조하므로 데이터 불일치가 발생하지 않는 정규화 모델
    - 적절한 업무 단위의 컬렉션으로 데이터가 분리되어 임베디드 방식 대비 도큐먼트의 크기 증가가 작음
    - 업무 요건 추가 및 변경으로 인한 도큐먼트 구조에 미치는 영향이 적음
- 문제점
    - 참조가 많은 도큐먼트 또는 대규모 도큐먼트를 조회하는 경우 애플리케이션에서 2차 쿼리로 인한 처리량 증가로 조회 성능 저하
    - 데이터 중복에 의한 데이터 일관성 문제는 해소되나 참조 정보를 정확하게 관리하지 않는 경우 참조 정보 소실에 의한 데이터 정합성 문제가 발생할 수 있음
- 권장
    - 조회 성능보다는 데이터 무결성이 중요한 업무
    - 임베디드 방식으로 사용 시 디스크 I/O 성능에 문제가 예상되는 업무
    - 데이터의 관계가 복잡하거나 계층 구조를 갖는 업무

### 레퍼런스 방식 (세부 레퍼런스 방식)

참조키를 어떤 도큐먼트에 저장할 것인지에 대한 전략

![스크린샷 2023-01-20 오후 6.09.57.png](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/fa206416-72ac-4d82-83ed-c2205880b960/%E1%84%89%E1%85%B3%E1%84%8F%E1%85%B3%E1%84%85%E1%85%B5%E1%86%AB%E1%84%89%E1%85%A3%E1%86%BA_2023-01-20_%E1%84%8B%E1%85%A9%E1%84%92%E1%85%AE_6.09.57.png)

- 자식 참조
    - 부모 도큐먼트에서 관계를 갖는 자식 도큐먼트의 식별자를 참조키로 저장하는 방식
    - 참조 정보가 부모 도큐먼트에만 존재하므로 관리가 편리함
    - 부모 도큐먼트에 업데이트가 집중되어 성능 문제가 발생할 수 있으며, 자식 도큐먼트가 많은 경우 도큐먼트의 최대 크기를 초과할 수 있음
    - 부모 도큐먼트에 발생하는 부하 및 크기 증가를 고려하여 자식 도큐먼트가 적게 생성되는 업무에 적합함
- 부모 참조
    - 자식 도큐먼트에서 관계를 갖는 부모 도큐먼트의 식별자를 참조키로 저장하는 방식
    - 자식 도큐먼트의 추가 및 삭제로 인한 부모 도큐먼트의 업데이트가 없음
    - 부모 도큐먼트와 관계를 갖는 모든 자식 도큐먼트 조회 시 소요시간이 증가할 수 있음
    - 이력 또는 로그 데이터와 같이 자식 도큐먼트가 많이 생성되는 업무에 적합함
- 상호 참조
    - 각각 서로의 식별자를 참조키로 저장하는 방식
    - 다른 방식에 비해 참조 정보 관리가 어려움
    - 상호 업데이트가 과도하게 발생할 수 있으며, 정보 관리 부주의로 데이터 정합성 문제가 쉽게 발생할 수 있음
    - 데이터 변경이 적고 서로를 빈번하게 참조하는 업무에 적합

### 컬렉션

RDB의 테이블과 같은 개념으로, 용도가 같거나 유사한 도큐먼트들의 그룹을 묶는 단위

- 일반 컬렉션
    - 가장 기본이 되는 컬렉션
- 캡드(capped) 컬렉션
    - 고정된 크기를 갖는 컬렉션
    - 높은 성능의 로깅 기능을 위해 설계됨
    - db.createCollection( "log"\, { capped : true, size : 100000, max : 100 } )
    - log - 생성 시 캡드 옵션을 설정하고, 사이즈를 설정
    - size - 최대 저장 크기, 단위는 Byte
    - max - 최대 도큐먼트 수 (생략 가능)
        - 도큐먼트 추가 시 디스크 공간이 없는 경우 가장 오래전에 추가된 도큐먼트 부터 덮어씀
        - 오래된 데이터를 수동으로 삭제하는 작업을 없애 데이터 관리가 편리함
        - 로깅을 위해 만들어져 사용자가 임의로 삭제하거나 업데이트할 수 없음
- TTL 컬렉션
    - 특정 시간이 경과한 도큐먼트를 자동으로 삭제하는 컬렉션
    - db.member.createIndex( { modify_date : 1 }\, { expireAfterSeconds : 3600 } )
    - modify_date 필드에 인덱스를 생성하여 시간이 지난 도큐먼트를 삭제
    - expireAfterSeconds : 도큐먼트 유지시간을 초 단위로 설정
        - “_id” 필드 또는 이미 다른 인덱스가 있는 필드는 TTL 인덱스를 가질 수 없음
        - 캡드 컬렉션인 경우 TTL 인덱스를 가질 수 없음
        - 단일 인덱스만 사용 가능하며 복합 인덱스를 가질 수 없음
- 시스템 컬렉션
    - mongoDB 내부에서 사용되는 컬렉션으로 사용자가 지정하여 사용할 수 없음